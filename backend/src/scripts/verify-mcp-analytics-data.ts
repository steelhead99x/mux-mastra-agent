#!/usr/bin/env tsx

/**
 * Comprehensive verification script for MCP Analytics Data Flow
 * Tests the entire data pipeline from MCP connection to TTS generation
 */

import { config } from 'dotenv';
import { resolve as resolvePath } from 'path';
import { existsSync } from 'fs';

// Load environment variables
const rootEnvPath = resolvePath(process.cwd(), '../.env');
if (existsSync(rootEnvPath)) {
  config({ path: rootEnvPath });
} else {
  config();
}

async function verifyMcpAnalyticsData() {
    console.log('üîç Verifying MCP Analytics Data Pipeline...\n');
    
    const results = {
        environmentCheck: false,
        mcpConnection: false,
        analyticsData: false,
        errorData: false,
        ttsToolData: false,
        systemPromptValid: false
    };
    
    try {
        // Step 1: Verify environment variables
        console.log('üìã Step 1: Checking Environment Variables...');
        const requiredEnvVars = {
            'MUX_TOKEN_ID': process.env.MUX_TOKEN_ID,
            'MUX_TOKEN_SECRET': process.env.MUX_TOKEN_SECRET,
            'DEEPGRAM_API_KEY': process.env.DEEPGRAM_API_KEY,
            'ANTHROPIC_API_KEY': process.env.ANTHROPIC_API_KEY,
        };
        
        let envVarsValid = true;
        for (const [key, value] of Object.entries(requiredEnvVars)) {
            const isValid = value && value.length > 20 && !value.includes('your_') && !value.includes('_here');
            console.log(`   ${isValid ? '‚úÖ' : '‚ùå'} ${key}: ${isValid ? 'Valid' : 'Missing or Invalid'}`);
            if (!isValid) envVarsValid = false;
        }
        
        if (!envVarsValid) {
            console.log('\n‚ö†Ô∏è  Environment variables are not properly configured.');
            console.log('   Please copy env.example to .env and fill in your credentials.');
            return results;
        }
        
        results.environmentCheck = true;
        console.log('   ‚úÖ All environment variables are valid\n');
        
        // Step 2: Test MCP Connection
        console.log('üîå Step 2: Testing MCP Connection...');
        const { muxDataMcpClient } = await import('../mcp/mux-data-client.js');
        
        try {
            await muxDataMcpClient.connect();
            const tools = await muxDataMcpClient.getTools();
            const toolNames = Object.keys(tools);
            
            console.log(`   ‚úÖ Connected to MCP successfully`);
            console.log(`   üì¶ Available tools: ${toolNames.length}`);
            console.log(`   üîß Tools: ${toolNames.slice(0, 5).join(', ')}${toolNames.length > 5 ? '...' : ''}`);
            
            results.mcpConnection = true;
            console.log();
            
        } catch (error) {
            console.log(`   ‚ùå MCP connection failed: ${error instanceof Error ? error.message : String(error)}`);
            console.log('   üîß Check MUX_MCP_DATA_ARGS in your .env file\n');
            return results;
        }
        
        // Step 3: Test Analytics Data Retrieval
        console.log('üìä Step 3: Testing Analytics Data Retrieval...');
        const { muxAnalyticsTool } = await import('../tools/mux-analytics.js');
        
        try {
            const analyticsResult = await (muxAnalyticsTool as any).execute({ 
                context: { timeframe: 'last 24 hours' } 
            });
            
            if (analyticsResult.success) {
                console.log('   ‚úÖ Analytics data retrieved successfully');
                console.log(`   üìÖ Time range: ${analyticsResult.timeRange.start} to ${analyticsResult.timeRange.end}`);
                
                if (analyticsResult.metrics) {
                    console.log('   üìà Metrics available:');
                    const metrics = analyticsResult.metrics;
                    if (metrics.total_views !== undefined) {
                        console.log(`      - Total views: ${metrics.total_views}`);
                    }
                    if (metrics.total_error_percentage !== undefined) {
                        console.log(`      - Error rate: ${metrics.total_error_percentage.toFixed(2)}%`);
                    }
                    if (metrics.total_rebuffer_percentage !== undefined) {
                        console.log(`      - Rebuffer rate: ${metrics.total_rebuffer_percentage.toFixed(2)}%`);
                    }
                    if (metrics.average_startup_time_ms !== undefined) {
                        console.log(`      - Avg startup time: ${(metrics.average_startup_time_ms / 1000).toFixed(2)}s`);
                    }
                }
                
                if (analyticsResult.analysis) {
                    console.log(`   üè• Health score: ${analyticsResult.analysis.healthScore}/100`);
                    console.log(`   üìù Summary: ${analyticsResult.analysis.summary}`);
                }
                
                results.analyticsData = true;
            } else {
                console.log(`   ‚ö†Ô∏è  Analytics data retrieval failed: ${analyticsResult.error || 'Unknown error'}`);
                console.log('   ‚ÑπÔ∏è  This may be normal if you have no recent video data');
            }
            console.log();
            
        } catch (error) {
            console.log(`   ‚ùå Analytics tool error: ${error instanceof Error ? error.message : String(error)}\n`);
        }
        
        // Step 4: Test Error Data Retrieval
        console.log('üö® Step 4: Testing Error Data Retrieval...');
        const { muxErrorsTool } = await import('../tools/mux-analytics.js');
        
        try {
            const errorsResult = await (muxErrorsTool as any).execute({ 
                context: { timeframe: 'last 24 hours' } 
            });
            
            if (errorsResult.success) {
                console.log('   ‚úÖ Error data retrieved successfully');
                console.log(`   üìÖ Time range: ${errorsResult.timeRange.start} to ${errorsResult.timeRange.end}`);
                console.log(`   üêõ Total errors: ${errorsResult.totalErrors || 0}`);
                
                if (errorsResult.platformBreakdown && errorsResult.platformBreakdown.length > 0) {
                    console.log('   üíª Platform breakdown:');
                    errorsResult.platformBreakdown.slice(0, 3).forEach((platform: any, idx: number) => {
                        const name = platform.field || platform.operating_system || 'Unknown';
                        const count = platform.value || platform.error_count || 0;
                        console.log(`      ${idx + 1}. ${name}: ${count} errors`);
                    });
                }
                
                results.errorData = true;
            } else {
                console.log(`   ‚ö†Ô∏è  Error data retrieval failed: ${errorsResult.error || 'Unknown error'}`);
                console.log('   ‚ÑπÔ∏è  This may be normal if you have no error data');
            }
            console.log();
            
        } catch (error) {
            console.log(`   ‚ùå Error tool error: ${error instanceof Error ? error.message : String(error)}\n`);
        }
        
        // Step 5: Test TTS Analytics Report Tool Data Flow
        console.log('üéß Step 5: Testing TTS Analytics Report Tool Data Flow...');
        
        try {
            // Import the agent to test the complete flow
            const { muxAnalyticsAgent } = await import('../agents/mux-analytics-agent.js');
            
            console.log('   ‚úÖ Mux Analytics Agent loaded');
            console.log(`   üìù Agent name: ${muxAnalyticsAgent.name}`);
            console.log(`   üîß Agent tools: ${Object.keys(muxAnalyticsAgent.tools || {}).length}`);
            
            // Check if ttsAnalyticsReportTool is available
            if (muxAnalyticsAgent.tools?.ttsAnalyticsReportTool) {
                console.log('   ‚úÖ ttsAnalyticsReportTool is available');
                results.ttsToolData = true;
            } else {
                console.log('   ‚ùå ttsAnalyticsReportTool is NOT available');
            }
            
            console.log();
            
        } catch (error) {
            console.log(`   ‚ùå TTS tool check error: ${error instanceof Error ? error.message : String(error)}\n`);
        }
        
        // Step 6: Verify System Prompt
        console.log('üìÑ Step 6: Verifying System Prompt Configuration...');
        
        try {
            const { muxAnalyticsAgent } = await import('../agents/mux-analytics-agent.js');
            
            const systemPrompt = muxAnalyticsAgent.instructions || '';
            
            // Check for key elements in the system prompt
            const promptChecks = {
                'MCP analytics data': systemPrompt.includes('Mux') && systemPrompt.includes('analytics'),
                'TTS generation': systemPrompt.includes('TTS') || systemPrompt.includes('audio'),
                'Error analysis': systemPrompt.includes('error'),
                'Platform data': systemPrompt.includes('platform') || systemPrompt.includes('browser'),
                'Asset ID rules': systemPrompt.includes('Asset ID') || systemPrompt.includes('assetId'),
                'URL format': systemPrompt.includes('streamingportfolio.com') || systemPrompt.includes('playerUrl'),
            };
            
            let allChecksPass = true;
            for (const [check, passed] of Object.entries(promptChecks)) {
                console.log(`   ${passed ? '‚úÖ' : '‚ö†Ô∏è '} ${check}`);
                if (!passed) allChecksPass = false;
            }
            
            if (allChecksPass) {
                results.systemPromptValid = true;
                console.log('   ‚úÖ System prompt is properly configured');
            } else {
                console.log('   ‚ö†Ô∏è  Some system prompt elements are missing');
            }
            console.log();
            
        } catch (error) {
            console.log(`   ‚ùå System prompt check error: ${error instanceof Error ? error.message : String(error)}\n`);
        }
        
        // Final Summary
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìä VERIFICATION SUMMARY');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        const checksTotal = Object.keys(results).length;
        const checksPassed = Object.values(results).filter(Boolean).length;
        const checksPercentage = ((checksPassed / checksTotal) * 100).toFixed(0);
        
        console.log(`\n‚úì Passed Checks: ${checksPassed}/${checksTotal} (${checksPercentage}%)`);
        console.log('\nDetailed Results:');
        console.log(`   ${results.environmentCheck ? '‚úÖ' : '‚ùå'} Environment Configuration`);
        console.log(`   ${results.mcpConnection ? '‚úÖ' : '‚ùå'} MCP Connection`);
        console.log(`   ${results.analyticsData ? '‚úÖ' : '‚ö†Ô∏è '} Analytics Data Retrieval ${!results.analyticsData ? '(may be normal if no data)' : ''}`);
        console.log(`   ${results.errorData ? '‚úÖ' : '‚ö†Ô∏è '} Error Data Retrieval ${!results.errorData ? '(may be normal if no errors)' : ''}`);
        console.log(`   ${results.ttsToolData ? '‚úÖ' : '‚ùå'} TTS Tool Configuration`);
        console.log(`   ${results.systemPromptValid ? '‚úÖ' : '‚ö†Ô∏è '} System Prompt Validity`);
        
        console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        if (checksPassed === checksTotal) {
            console.log('üéâ EXCELLENT: All checks passed! The system is fully operational.');
            console.log('\nüìù The Mux Analytics Agent is properly configured to:');
            console.log('   - Connect to Mux via MCP');
            console.log('   - Retrieve analytics and error data');
            console.log('   - Generate TTS audio reports');
            console.log('   - Follow proper URL and asset ID formatting');
        } else if (checksPassed >= checksTotal * 0.7) {
            console.log('‚úÖ GOOD: Most checks passed. System is operational.');
            console.log('\n‚ö†Ô∏è  Some optional features may not work as expected.');
            console.log('   Review the failed checks above for details.');
        } else {
            console.log('‚ùå ISSUES DETECTED: Critical checks failed.');
            console.log('\nüîß Action Required:');
            console.log('   1. Ensure all environment variables are set correctly');
            console.log('   2. Verify MCP connection is working');
            console.log('   3. Check that Mux credentials have proper permissions');
            console.log('   4. Review the detailed results above');
        }
        
        console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        
        return results;
        
    } catch (error) {
        console.error('\nüí• Verification failed with error:', error);
        return results;
    }
}

// Run the verification
if (import.meta.url === `file://${process.argv[1]}`) {
    verifyMcpAnalyticsData()
        .then(results => {
            const checksTotal = Object.keys(results).length;
            const checksPassed = Object.values(results).filter(Boolean).length;
            
            if (checksPassed === checksTotal) {
                process.exit(0);
            } else if (checksPassed >= checksTotal * 0.7) {
                process.exit(0);
            } else {
                process.exit(1);
            }
        })
        .catch(error => {
            console.error('üí• Verification crashed:', error);
            process.exit(1);
        });
}

export { verifyMcpAnalyticsData };

